name: Deploy Streamlit RAG LLM App

on:
  push:
    branches:
      - main
    paths:
      - 'python/**'
      - 'config/requirements.txt'
      - '.github/workflows/deploy-streamlit.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: config/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r config/requirements.txt

      - name: Validate Python app
        working-directory: ./python
        run: |
          python -m py_compile src/app.py
          python -m py_compile src/llm_helper.py
          python -m py_compile src/data_factory.py
          python -m py_compile src/data_processor.py
          python -m py_compile src/charts.py

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare Docker build
        run: |
          # Copy split requirements files from config to python directory
          # Split requirements into batches to reduce peak disk usage during Docker build
          
          # Core dependencies (lines 1-7)
          sed -n '1,7p' config/requirements.txt | grep -v '^$' > python/requirements-core.txt
          
          # ML dependencies (line 8 and lines 10-12, skipping comment on line 9)
          { sed -n '8p' config/requirements.txt; sed -n '10,12p' config/requirements.txt; } | grep -v '^$' > python/requirements-ml.txt
          
          # Vector DB dependencies (lines 13-15)
          sed -n '13,15p' config/requirements.txt | grep -v '^$' > python/requirements-vectordb.txt
          
          # Keep full requirements.txt for reference
          cp config/requirements.txt python/requirements.txt

      - name: Build Docker image
        working-directory: ./python
        run: |
          docker build -t streamlit-rag-llm:latest .
          echo "Docker image built successfully"

      - name: Deployment Information
        run: |
          echo "‚úÖ Streamlit app validation completed successfully"
          echo ""
          echo "üì¶ Docker image built: streamlit-rag-llm:latest"
          echo ""
          echo "üöÄ Deployment Options:"
          echo ""
          echo "Option 1 - Streamlit Community Cloud:"
          echo "  1. Visit https://share.streamlit.io"
          echo "  2. Connect your GitHub repository"
          echo "  3. Select 'python/src/app.py' as the main app"
          echo "  4. Configure secrets: DEEPSEEK_API_KEY, DEEPSEEK_BASE_URL"
          echo ""
          echo "Option 2 - Docker Deployment:"
          echo "  docker run -p 8501:8501 -e DEEPSEEK_API_KEY=your_key streamlit-rag-llm:latest"
          echo ""
          echo "Option 3 - Cloud Platforms (Railway, Render, Heroku):"
          echo "  - Configure Docker deployment from this repository"
          echo "  - Set environment variables for API keys"
          echo ""
          echo "‚ÑπÔ∏è Note: Remember to set the DEEPSEEK_API_KEY environment variable for LLM features"
